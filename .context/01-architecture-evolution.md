# Architecture Evolution - μ•„ν‚¤ν…μ² μ§„ν™” κ³Όμ •

## ν„μ¬ μ•„ν‚¤ν…μ²: 2κ³„μΈµ ν—¥μ‚¬κ³ λ‚  (2025-01-08)

### κµ¬μ΅°
```
internal/
β”β”€β”€ domain/              # λΉ„μ¦λ‹μ¤ λ΅μ§ & μΈν„°νμ΄μ¤ (μμ λ„λ©”μΈ)
β”‚   β”β”€β”€ backup/         # λ°±μ—… μΈν„°νμ΄μ¤
β”‚   β”β”€β”€ restore/        # λ³µμ› μΈν„°νμ΄μ¤
β”‚   β”β”€β”€ metadata/       # λ©”νƒ€λ°μ΄ν„° μΈν„°νμ΄μ¤
β”‚   β”β”€β”€ logger/         # λ΅κ±° μΈν„°νμ΄μ¤
β”‚   β”β”€β”€ log/            # μ‘μ—… μ΄λ ¥ λ„λ©”μΈ
β”‚   β””β”€β”€ progress/       # μ§„ν–‰λ¥  νƒ€μ…
β””β”€β”€ infrastructure/      # μ™Έλ¶€ μ‹μ¤ν… μ—°λ™ & κµ¬ν„μ²΄
    β”β”€β”€ config/         # μ„¤μ • κ΄€λ¦¬
    β”β”€β”€ filesystem/     # νμΌμ‹μ¤ν… provider κµ¬ν„
    β”β”€β”€ kubernetes/     # K8s ν΄λΌμ΄μ–ΈνΈ
    β”β”€β”€ logger/         # λ΅κ±° κµ¬ν„μ²΄
    β”β”€β”€ progress/       # μ§„ν–‰λ¥  κµ¬ν„μ²΄
    β””β”€β”€ metadata/       # λ©”νƒ€λ°μ΄ν„° νμΌ μ €μ¥μ†
```

### μ±…μ„ λ¶„λ¦¬
```
Domain Layer (What & Why)
β”β”€β”€ λΉ„μ¦λ‹μ¤ κ·μΉ™
β”β”€β”€ λ„λ©”μΈ λ¨λΈ
β”β”€β”€ μΈν„°νμ΄μ¤ μ •μ
β””β”€β”€ μ™Έλ¶€ μμ΅΄μ„± μ—†μ

Infrastructure Layer (How)
β”β”€β”€ Domain μΈν„°νμ΄μ¤ κµ¬ν„
β”β”€β”€ μ™Έλ¶€ μ‹μ¤ν… ν†µν•©
β”β”€β”€ νμΌ/λ„¤νΈμ›ν¬ I/O
β””β”€β”€ μ‹¤μ  μ €μ¥μ† κµ¬ν„
```

### μμ΅΄μ„± λ°©ν–¥
- CMD β†’ Infrastructure β†’ Domain
- Domainμ€ μμν•¨ (no imports)
- Infrastructureκ°€ Domainμ— μμ΅΄

## μ•„ν‚¤ν…μ² μ „ν™ κ³Όμ •

### Phase 1-3: μ΄κΈ° 3κ³„μΈµ κµ¬μ΅°
```
cmd/
β”β”€β”€ adapter/        # Application λ μ΄μ–΄
β”β”€β”€ domain/         # Domain λ μ΄μ–΄
β””β”€β”€ infrastructure/ # Infrastructure λ μ΄μ–΄
```

### Phase 3.9: 2κ³„μΈµμΌλ΅ λ‹¨μν™” β…
**λ¬Έμ μ  λ°κ²¬**:
- Application λ μ΄μ–΄κ°€ λ‹¨μ μ „λ‹¬λ§ μν–‰
- Registry ν¨ν„΄μ΄ provider 1κ°λ§ κ΄€λ¦¬
- κ³Όλ„ν• μ¶”μƒν™”λ΅ λ³µμ΅λ„ μ¦κ°€

**ν•΄κ²°μ±…**:
- Application λ μ΄μ–΄ μ κ±°
- Registry β†’ Factory ν•¨μλ΅ κµμ²΄
- μ§μ ‘μ μΈ νΈμ¶ κµ¬μ΅°

**κ²°κ³Ό**:
- λ³µμ΅λ„: 75 β†’ 30
- νμΌ μ: -40%
- μ½”λ“ λΌμΈ: -35%

## λ°κ²¬λ ν•κ³„μ 

### 1. κ³µν†µ μΈν„°νμ΄μ¤μ μ–µμ••
```go
// ν„μ¬: λ¨λ“  Providerκ°€ κ°™μ€ μΈν„°νμ΄μ¤ κ°•μ 
type Provider interface {
    Execute(ctx context.Context, opts Options) error
    EstimateSize(opts Options) (int64, error)
    StreamProgress() <-chan Progress
}
```
- Filesystem: `du -s`λ΅ κ°„λ‹¨
- MongoDB: dump ν›„μ—λ‚ μ• μ μμ
- MinIO: λ©”νƒ€λ°μ΄ν„°λ΅ μ¦‰μ‹ κ³„μ‚°

### 2. Options κµ¬μ΅°μ²΄ λΉ„λ€ν™”
```go
type Options struct {
    // κ³µν†µ ν•„λ“
    Namespace   string
    Pod         string
    
    // Backup μ „μ©
    SourcePath  string
    Compression string
    
    // Restore μ „μ©
    BackupFile  string
    Overwrite   bool
    
    // MongoDB μ „μ© (λ―Έλ)
    Collections []string
    OpLog      bool
    
    // MinIO μ „μ© (λ―Έλ)
    Bucket     string
    Prefix     string
}
```

### 3. Providerλ³„ νΉμ„± λ¬΄μ‹
- Filesystem: tar κΈ°λ°
- MongoDB: BSON dump
- MinIO: S3 API
- κ°κ° μ™„μ „ν λ‹¤λ¥Έ ν¨λ¬λ‹¤μ„

## λ―Έλ λ°©ν–¥: Provider κ²©λ¦¬ μ•„ν‚¤ν…μ²

### μ² ν•™
> "Duplication is cheaper than the wrong abstraction"  
> β€” Sandi Metz

> "Isolation with minimal coordination"  
> β€” μ°λ¦¬μ κ²°λ΅ 

### λ©ν‘ κµ¬μ΅°
```
cli-recover/
β”β”€β”€ providers/
β”‚   β”β”€β”€ filesystem/      # 100% λ…λ¦½
β”‚   β”‚   β”β”€β”€ backup.go    # tar νΉν™” κµ¬ν„
β”‚   β”‚   β”β”€β”€ restore.go   # λ³µμ› νΉν™” κµ¬ν„
β”‚   β”‚   β”β”€β”€ tui.go       # filesystem μ „μ© TUI
β”‚   β”‚   β””β”€β”€ tests/       # λ…λ¦½ ν…μ¤νΈ
β”‚   β”‚
β”‚   β””β”€β”€ mongodb/         # 100% λ…λ¦½
β”‚       β”β”€β”€ dump.go      # mongodump νΉν™”
β”‚       β”β”€β”€ restore.go   # mongorestore νΉν™”
β”‚       β”β”€β”€ tui.go       # MongoDB μ „μ© TUI
β”‚       β””β”€β”€ tests/       # λ…λ¦½ ν…μ¤νΈ
β”‚
β””β”€β”€ internal/shared/     # μµμ† κ³µμ λ§
    β”β”€β”€ logger/         # λ΅κ·Έ μΌκ΄€μ„±
    β””β”€β”€ errors/         # μ‚¬μ©μ κ²½ν—
```

### μ¥μ 
1. **μ™„λ²½ν• κ²©λ¦¬**
   - ν• Provider λ²„κ·Έκ°€ λ‹¤λ¥Έ κ³³ μν–¥ μ—†μ
   - λ…λ¦½μ  λ°°ν¬/λ΅¤λ°± κ°€λ¥

2. **Providerλ³„ μµμ ν™”**
   - κ°μμ—κ² λ§λ” μµμ„ μ κµ¬ν„
   - νƒ€ν‘ μ—†λ” μ„±λ¥

3. **λ‹¨μν•¨**
   - μƒ κ°λ°μκ°€ ν•λ‚μ Providerλ§ μ΄ν•΄ν•λ©΄ λ¨
   - μ „μ²΄ μ‹μ¤ν… μ΄ν•΄ λ¶ν•„μ”

## λ§μ΄κ·Έλ μ΄μ… μ „λµ

### experimental/ λ””λ ‰ν† λ¦¬ ν™μ©
```
cli-recover/                    # κΈ°μ΅΄ κµ¬μ΅° (μ μ§€)
experimental/                   # μƒλ΅μ΄ μ‹¤ν—
β””β”€β”€ providers/
    β””β”€β”€ filesystem_v2/         # κ²©λ¦¬λ κµ¬ν„
```

### Feature Toggle
```go
if os.Getenv("USE_EXPERIMENTAL") == "true" {
    // μƒλ΅μ΄ κ²©λ¦¬λ κµ¬ν„
} else {
    // κΈ°μ΅΄ κµ¬ν„ (λ³€κ²½ μ—†μ)
}
```

### μ„±κ³µ νλ‹¨ κΈ°μ¤€
- μ½”λ“ λ³µμ΅λ„ κ°μ†
- ν…μ¤νΈ λ…λ¦½μ„± ν–¥μƒ
- Providerλ³„ μμ λ„ μ¦κ°€
- λ²„κ·Έ κ²©λ¦¬ ν™•μΈ

## κµν›

### μ•„ν‚¤ν…μ² μ§„ν™”μ κµν›
1. **κ³Όλ„ν• λ―Έλ λ€λΉ„λ” λ…**
   - ν•„μ”ν•  λ• μ¶”κ°€ν•λ” κ²ƒμ΄ μ‰¬μ›€
   - λ¶ν•„μ”ν• λ³µμ΅λ„ μ κ±°κ°€ μ–΄λ ¤μ›€

2. **λ‹¨μν•¨μ΄ μµμ„ **
   - μ΄ν•΄ν•κΈ° μ‰¬μ΄ μ½”λ“
   - μ μ§€λ³΄μ μ©μ΄
   - λ²„κ·Έ κ°μ†

3. **κ²©λ¦¬κ°€ ν†µν•©λ³΄λ‹¤ λ‚μ„ μ μλ‹¤**
   - μλ»λ μ¶”μƒν™”μ λΉ„μ©
   - μ¤‘λ³µ ν—μ©μ μ‹¤μ©μ„±
   - Providerλ³„ λ…λ¦½μ„±μ κ°€μΉ

### λ¦¬ν©ν† λ§μ κµν›
- κ°™μ€ λ””λ ‰ν† λ¦¬μ—μ„ λ¦¬ν©ν† λ§ β†’ νΌλ€
- experimental/ κ²©λ¦¬ β†’ λ…ν™•ν• κ²½κ³„
- μ„±κ³µ μ¦λ… ν›„ ν†µν•© β†’ μ•μ „ν• μ§„ν™”

## ν„μ¬ μƒνƒ λ° λ‹¤μ λ‹¨κ³„

### μ™„λ£λ¨
- β… 2κ³„μΈµ μ•„ν‚¤ν…μ² κµ¬ν„
- β… κΈ°λ³Έ κΈ°λ¥ λ¨λ‘ λ™μ‘
- β… ν…μ¤νΈ μ»¤λ²„λ¦¬μ§€ 52.9%

### μ§„ν–‰ μ¤‘
- π§ Provider κ²©λ¦¬ μ‹¤ν— μ¤€λΉ„
- π“ experimental/ μ „λµ μλ¦½

### λ―Έλ
- Providerλ³„ λ…λ¦½ κµ¬μ΅°
- κ°μμ μ†λ„λ΅ μ§„ν™”
- μ‹¤μ  ν•„μ” κΈ°λ° ν™•μ¥